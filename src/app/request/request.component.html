<div class="container fc-primary">
  <div class="row my-5">
    <div class="col-12" *ngIf="!request; else resultBlock">
      <mat-spinner class="mx-auto"></mat-spinner>
    </div>
    <ng-template #resultBlock>
      <div class="col-12 text-center" *ngIf="!request.expectedAmount; else requestBlock">
        <img class="mx-auto" src="assets/img/searching.png" style="max-width: 120px;">
        <h1 class="my-3">Oops</h1>
        <p>Sorry, we couldn’t find any matches for this Request ID.</p>
        <p>Please try searching with another ID.</p>
        <button mat-raised-button routerLink="/" style="text-decoration: none" class="px-5 my-5" color="accent">Back home</button>
      </div>
      <ng-template #requestBlock>
        <div class="col-md-3">
          <input mat-button class="url-box fc-blue-grey fs-12 px-3 w-100" [value]="url" disabled>
          <button mat-button class="w-100 fs-16 bor-accent my-3" style="height: 50px" color="accent" type="button" ngxClipboard [cbContent]="url" (cbOnSuccess)="copyToClipboard()">{{copyUrlTxt}}</button>
          <hr style="border-top: 1px solid #617B9F; opacity: 0.2">
          <div class="fc-blue-grey" *ngIf="request.history">
            <p class="semi-bold">
              History
            </p>
            <div *ngFor="let e of request.history" class="fs-14 d-flex justify-content-between">
              <span>{{e.name}}</span>
              <span>{{e._meta.blockNumber}}</span>
            </div>
          </div>
        </div>
        <div class="ml-auto col-md-8">
          <mat-card class="p-0 br-7 sh-blue">
            <div class="d-flex bg-primary p-4 btr-7">
              <img class="px-3" style="max-height: 75px;" src="assets/img/request-logo.png">
              <div class="ml-auto text-right px-3 fc-white">
                <h4 class="semi-bold fs-18">
                  <span *ngIf="request.state; else waitingTemplate" popover="{{request.requestId}}" popoverPlacement="bottom" [popoverOnHover]="true" [popoverCloseOnMouseOutside]="true">Request Id: {{request.requestId.substring(0, 5)}}...{{request.requestId.substring(56, 66)}}</span>
                  <ng-template #waitingTemplate><span><i class="fa fa-circle-o-notch fa-spin"></i>&nbsp;{{request.requestId}}</span></ng-template>
                </h4>
                <div class="fs-14" [style.opacity]="'0.5'">
                  <i>{{request.data.data.date | date: 'fullDate'}}</i>
                </div>
                <div class="mt-1">
                  <a *ngIf="txHash" class="fs-14" style="opacity: 0.8; color: #5392ff !important;" href="{{web3Service.etherscanUrl}}tx/{{txHash}}" target="_blank"><i>{{web3Service.etherscanUrl}}tx/{{txHash.substring(0, 10)}}...</i></a>
                  <span *ngIf="request.status" class="status fs-12 fc-white px-2 py-1">&nbsp;{{request.status}}</span>
                </div>
              </div>
            </div>
            <div class="bg-grey-whiter fc-blue-grey p-4 d-flex flex-wrap">
              <div class="d-flex mb-3 m-lg-0" style="flex: 1">
                <div class="px-3">
                  <img *ngIf="request.payee" [src]="blockies({ seed: request.payee.toLowerCase() }).toDataURL()" style="width: 50px; height: 50px; image-rendering: pixelated; border-radius: 25px" />
                </div>
                <div class="fs-14 lh-18">
                  <div class="mb-1" [style.opacity]="'0.5'">FROM</div>
                  <div class="semi-bold">ETH address</div>
                  <div popover="{{request.payee}}" popoverPlacement="bottom" [popoverOnHover]="true" [popoverCloseOnMouseOutside]="true">{{request.payee.substring(0, 10)}}...{{request.payee.substring(32, 42)}}</div>
                </div>
              </div>
              <div class="d-flex" style="flex: 1">
                <div class="px-3">
                  <img *ngIf="request.payer" [src]="blockies({ seed: request.payer.toLowerCase() }).toDataURL()" style="width: 50px; height: 50px; image-rendering: pixelated; border-radius: 25px" />
                </div>
                <div class="fs-14 lh-18">
                  <div class="mb-1" [style.opacity]="'0.5'">TO</div>
                  <div class="semi-bold">ETH address</div>
                  <div popover="{{request.payer}}" popoverPlacement="bottom" [popoverOnHover]="true" [popoverCloseOnMouseOutside]="true">{{request.payer.substring(0, 10)}}...{{request.payer.substring(32, 42)}}</div>
                </div>
              </div>
            </div>
            <div class="fc-blue-grey p-4" style="border-bottom: 1px solid #DFE5EC">
              <div class="px-3" *ngFor="let data of objectKeys(request.data.data)" [hidden]="data == 'date'">
                <div class="semi-bold">{{data}}</div>
                <div>{{request.data.data[data]}}</div>
              </div>
            </div>
            <div class="d-flex">
              <div class="ml-auto d-inline-block semi-bold fc-primary px-5 py-3" style="background: #DFE5EC">
                <div class="fs-14">AMOUNT</div>
                <div class="fs-24">{{web3Service.fromWei(request.expectedAmount)}} ETH</div>
              </div>
            </div>
            <div class="p-5">
              <div class="fc-blue-grey fs-12 mx-auto w-50 text-center">
                <div><strong>{{progress | number: '1.0-2'}}%</strong> of the Request has been paid</div>
                <mat-progress-bar class="my-1" mode="determinate" [value]="progress"></mat-progress-bar>
                <div [ngSwitch]="request.status">
                  <span *ngSwitchCase="'overpaid'"><strong>{{ web3Service.fromWei(request.expectedAmount.sub(request.balance).abs()) }} ETH</strong> overpaid</span>
                  <span *ngSwitchCase="'complete'">&nbsp;</span>
                  <span *ngSwitchDefault><strong>{{ web3Service.fromWei(request.expectedAmount.sub(request.balance)) }} ETH</strong> remains to be paid</span>
                </div>
              </div>
            </div>
            <mat-toolbar class="p-0 bbr-7 cta-toolbar" [style.height]="'90px'">
              <!-- VIEW MODE / BROADCASTING-->
              <div *ngIf="!request.state; else ctaMode" class="text-center fs-12 lh-14 h-100">
                <mat-icon class="mx-auto mt-3" color="accent">remove_red_eye</mat-icon>
                <div class="fc-primary semi-bold">
                  <i>You are in view mode.<br/> Synchronizing the request with the blockchain can take between 1sec and a couple of minutes.</i>
                </div>
              </div>
              <ng-template #ctaMode>
                <!-- STATE == CANCELED -->
                <div *ngIf="request.state == 2; else ctaBlock" class="text-center fs-12 lh-14 h-100">
                  <mat-icon class="mx-auto mt-3" color="warn">lock</mat-icon>
                  <div class="semi-bold fc-warn"><i>This request has been cancelled.<br/>You can’t interact with it anymore.</i></div>
                </div>
                <!-- NORMAL STATES -->
                <ng-template #ctaBlock>
                  <div class="h-100 w-100 fs-18" [ngSwitch]="mode">
                    <!-- PAYEE -->
                    <div *ngSwitchCase="'payee'" class="d-flex h-100">
                      <button type="button" class="fs-18 bg-grey-whiter fc-blue-grey" mat-raised-button [matMenuTriggerFor]="payeeActionsMenu">Actions&nbsp;
                        <mat-icon>expand_more</mat-icon>
                      </button>
                      <mat-menu #payeeActionsMenu="matMenu" [overlapTrigger]="false" class="actionsMenu">
                        <button (click)="cancelRequest()" [disabled]="request.balance > 0" mat-menu-item>
                          Cancel this Request
                        </button>
                        <button (click)="refundRequest()" *ngIf="request.balance != 0" mat-menu-item>
                          <span>Refund</span>
                        </button>
                      </mat-menu>
                      <button class="ml-auto fs-18 no-focus-overlay" mat-raised-button color="accent" (click)="subtractRequest()">Update the Request</button>
                    </div>
                    <!-- PAYER -->
                    <div *ngSwitchCase="'payer'" class="d-flex h-100">
                      <button type="button" class="fs-18 bg-grey-whiter fc-blue-grey" mat-raised-button [matMenuTriggerFor]="payerActionsMenu">Actions&nbsp;
                        <mat-icon>expand_more</mat-icon>
                      </button>
                      <mat-menu #payerActionsMenu="matMenu" [overlapTrigger]="false" class="actionsMenu">
                        <button (click)="cancelRequest()" *ngIf="request.state == 0" mat-menu-item>
                          Decline this Request
                        </button>
                        <button (click)="acceptRequest()" *ngIf="request.state != 1" mat-menu-item>
                          <span>Accept & pay later</span>
                        </button>
                        <button (click)="additionalRequest()" mat-menu-item>
                          <span>Update the Request</span>
                        </button>
                      </mat-menu>
                      <button class="ml-auto fs-18 no-focus-overlay" mat-raised-button color="accent" (click)="payRequest()">
                        <span>{{request.state != 1 ? 'Accept & Pay': 'Pay'}}</span>
                      </button>
                    </div>
                    <!-- ELSE -->
                    <div *ngSwitchDefault class="text-center fs-12 lh-14 h-100">
                      <mat-icon class="mx-auto mt-3" color="accent">remove_red_eye</mat-icon>
                      <div class="fc-primary semi-bold">
                        <i>You are in view mode.<br/> Connect your metamask account as the payer or payee to interact with this Request.</i>
                      </div>
                    </div>
                  </div>
                </ng-template>
              </ng-template>
            </mat-toolbar>
          </mat-card>
        </div>
      </ng-template>
    </ng-template>
  </div>
</div>
